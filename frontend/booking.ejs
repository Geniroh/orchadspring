<!doctype html>
<html class="no-js" lang="">
    <%- include('./partials/head.ejs') %>
    <body class="white-background">
        <%- include('./partials/nav.ejs') %>

        <!-- main-area -->
        <main>

            <!-- breadcrumb-area -->
            <section class="breadcrumb-area breadcrumb-bg">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="breadcrumb-content text-center">
                                <h2 class="title">Orchid Springs Booking</h2>
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                                        <li class="breadcrumb-item active" aria-current="page">Booking</li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- breadcrumb-area-end -->

            <!-- customer-details-area -->
            <section class="customer-details-area">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <div class="customer-details-content">
                                <div class="icon">
                                    <img src="assets/img/icon/customer_det_icon.jpg" alt="">
                                </div>
                                <div class="content">
                                    <h2 class="title">Please select a space</h2>
                                    <div class="customer-progress-wrap">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0"
                                                aria-valuemax="100"></div>
                                        </div>
                                        <div class="customer-progress-step">
                                            <ul>
                                                <li>
                                                    <span>1</span>
                                                    <p>Space selection</p>
                                                </li>
                                                <li>
                                                    <span>2</span>
                                                    <p>Guest Information</p>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- customer-details-area-end -->

            <div class="container">
                <div class="alert alert-primary" role="alert" id="alert_date">
                    A simple primary alertâ€”check it out!
                </div>
            </div>

             <!-- booking-area -->
             <section class="booking-details-area">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-73">
                            <div class="alert alert-warning text-center" id="loading-alert" style="display: none;">
                                <h4>Please wait while spaces are loading...</h4>
                            </div>
                            <form action="/booking-details" method="get" id="reservationForm">

                                <div class="primary-contact">
                                    <i class="fa-regular fa-user"></i>
                                    <h2 class="title">Office desk selection</h2>
                                </div>
                                
                                <div class="booking-details-wrap">
                                    <div class="row">
                                        <div class="col-8">
                                           
                                        </div>
                                        <div class="col-4">
                                            <div class="service-nav" title="Use arrow to navigate between days"></div>
                                        </div>
                                    </div>
                                    <% 
                                        const outputFormat = 'yyyy-MM-dd';
                                        function formatDate(inputDateString, outputFormat) {
                                            const inputDate = new Date(inputDateString);
                                            if (isNaN(inputDate)) return 'Invalid Date';
                            
                                            const dateValues = {
                                                'yyyy': inputDate.getFullYear(),
                                                'MM': String(inputDate.getMonth() + 1).padStart(2, '0'),
                                                'dd': String(inputDate.getDate()).padStart(2, '0'),
                                            };
                            
                                            const formattedDate = outputFormat.replace(/(yyyy|MM|dd)/g, (match) => dateValues[match] || match);
                            
                                            return formattedDate;
                                        }
                    
                                    %>
                                    <div class="test-slick">
                                        <% if (dates.length > 0) { %>
                                            <% dates.forEach(function(date, i) { %>
                                                <div class="container">
                                                    <div class="row">
                                                        <div class="col-md-7">
                                                            <h5>Day <%= i +1 %> , <%= date %> </h5>
                                                            <ul class="booking-color-codes">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <label class="green-box"></label>Available
                                                                </div>
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <label class="ash-box"></label>Selected
                                                                </div>
                                                            </ul>
                                                            <div class="selection-container-4">
                                                                <% if (deskspaces.length > 0) { %>
                                                                    <% deskspaces.forEach(function(space) { %>
                                                                        <label>
                                                                            <input type="checkbox" class="hide-checkbox" id="space_<%= space._id %>" data-space-price="<%= space.price %>" data-space-id="<%= space._id %>" name="space_id" value="<%= space._id %>" data-current-date="<%= formatDate(date, 'yyyy-MM-dd') %>">
                                                                            <div class="checkbox-container" style="padding: 15px;" title="<%= space.name %>"><%= space.seat_number %></div>
                                                                        </label>
                                                                    <% }); %>
                                                                <% } else { %>
                                                                    <p>No data available.</p>
                                                                <% } %>
                                                            </div>
                                                            
                                                        </div>
                                                        <div class="col-md-5">
                                                            <ul class="booking-color-codes">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <label class="red-box"></label>Doors
                                                                </div>
                                                                <div class="d-flex align-items-center gap-2"2>
                                                                    <label class="green-box"></label>Windows
                                                                </div>
                                                            </ul>
                                                            <img src="assets/img/images/layout.png" alt="">
                                                        </div>
                                                    </div>
                                                    <div class="div">
                                                        <div class="selection-container-2 mt-6">
                                                            <% if (roomspaces.length > 0) { %>
                                                                <% roomspaces.forEach(function(space) { %>
                                                                    <label>
                                                                        <input type="checkbox" class="hide-checkbox" data-space-price="<%= space.price %>" data-space-id="<%= space._id %>" id="space_<%= space._id %>" name="space_id" data-current-date="<%= formatDate(date, 'yyyy-MM-dd') %>" value="<%= space._id %>" >
                                                                        <div class="checkbox-container" style="padding: 15px;" title="<%= space.name %>"><%= space.name %></div>
                                                                    </label>
                                                                <% }); %>
                                                            <% } else { %>
                                                                <p>No data available.</p>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        <%} %>
                                        
                                        
                                    </div>
                                </div>
    
                                <input type="hidden" name="start_date" id="s-date">
                                <input type="hidden" name="end_date" id="e-date">

                                <button type="submit" class="btn pt-3 d-block" style="width: 100%;">Proceed</a>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
            <!-- booking-area-end -->
            

        </main>
        <!-- main-area-end -->
        <%- include('./partials/footer.ejs') %>
        <script>
            document.addEventListener("DOMContentLoaded", function(event){
                const queryString = window.location.search;
    
                function parseQueryString(queryString) {
                    const params = new URLSearchParams(queryString);
                    const queryParameters = {};
                    for (const [key, value] of params.entries()) {
                        queryParameters[key] = value;
                    }
                    return queryParameters;
                }

                const queryParams = parseQueryString(queryString);
                const sDate = document.querySelector('#s-date').value = queryParams.start_date;
                const eDate = document.querySelector('#e-date').value = queryParams.end_date;
    
                function formatDate(inputDateString, outputFormat) {
                    const inputDate = new Date(inputDateString);
                    if (isNaN(inputDate)) return 'Invalid Date';
    
                    const dateValues = {
                        'yyyy': inputDate.getFullYear(),
                        'MM': String(inputDate.getMonth() + 1).padStart(2, '0'),
                        'dd': String(inputDate.getDate()).padStart(2, '0'),
                    };
    
                    const formattedDate = outputFormat.replace(/(yyyy|MM|dd)/g, (match) => dateValues[match] || match);
    
                    return formattedDate;
                }

                const outputFormat = 'yyyy-MM-dd';

                const calculateDays = (start_date, end_date) => {
                    if (!(start_date instanceof Date)) {
                        start_date = new Date(start_date);
                    }
                    if (!(end_date instanceof Date)) {
                        end_date = new Date(end_date);
                    }

                    const timeDiff = end_date - start_date;
                    const days = Math.ceil(timeDiff / (1000 * 3600 * 24));

                    if(days === 0){
                        return 1
                    } else {
                        return days;
                    }
                };

                const days = calculateDays(queryParams.start_date, queryParams.end_date)
                
                const startDate = document.querySelector('#alert_date')
                startDate.innerText = `You are booking for: ${formatDate(queryParams.start_date, outputFormat)} to ${formatDate(queryParams.end_date, outputFormat)} please use the arrows to navigate and select your space(s)`

                function areDatesEqual(date1, date2) {
                    date1 = new Date(date1);
                    date2 = new Date(date2)
                    return date1.toISOString().slice(0, 10) === date2.toISOString().slice(0, 10);
                }

                const loadingAlert = document.querySelector('#loading-alert');
                const reservationForm = document.querySelector('#reservationForm');

                const checkboxes = document.querySelectorAll('.hide-checkbox');
                checkboxes.forEach(async (checkbox) => {
                    const spaceId = checkbox.getAttribute('data-space-id');
                    loadingAlert.style.display = 'block'
                    // reservationForm.style.display = 'none'
                    try {
                        const response = await axios.post('/api/reservation/check', {
                            space_id: spaceId,
                            start_date: queryParams.start_date,
                            end_date: queryParams.end_date,
                        });

                        if (response.data.available) {
                            checkbox.checked = false
                        } else if (response.data.overlappingReservations.length > 0) {
                            let currentDate = checkbox.getAttribute('data-current-date');
                            response.data.overlappingReservations.forEach((element,i) => {
                                element.dates.forEach(el => {
                                    if(areDatesEqual(currentDate, el) && element.status === 'completed') {
                                        checkbox.checked = true;
                                        checkbox.disabled = true;
                                    }
                                })
                            });
                        } else {
                            checkbox.checked = true;
                            checkbox.disabled = true;
                        }

                    } catch (error) {
                        console.error('Error checking availability:', error);
                    }
                    loadingAlert.style.display = 'none'
                    // reservationForm.style.display = 'block'
                });

    

            });


        </script>
    </body>
</html>

